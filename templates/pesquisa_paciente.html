{% extends "base.html" %}
{% block title %}Pesquisa de Pedido{% endblock %}

{% block content %}
<div class="container main-content">
    <div class="page-header">
        <h2>Pesquisa de Pedido</h2>
        <p>Busque pelo nome do paciente ou pelo número de protocolo.</p>
    </div>

    <form method="POST" class="form-pesquisa" autocomplete="off">
        <div class="autocomplete-wrapper">
            <input type="text" id="campoPesquisa" name="termo" 
                   placeholder="Digite o nome ou protocolo" 
                   value="{{ termo }}" required>
            <div id="sugestoes" class="sugestoes-lista"></div>
        </div>
        <button type="submit" class="btn btn-primary">Pesquisar</button>
    </form>

    {% if termo and not resultados %}
    <div class="empty-state">
        <p>Nenhum pedido encontrado para <strong>{{ termo }}</strong>.</p>
    </div>
    {% endif %}

    {% if resultados %}
    <table class="tabela-pedidos">
        <thead>
            <tr>
                <th>Nome</th>
                <th>Exame</th>
                <th>Prioridade</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for p in resultados %}
            {% set safe = p.protocolo|replace(' ', '_')|replace('/', '_') %}
            <tr class="linha-pedido" data-id="{{ safe }}">
                <td>{{ p.nome_paciente }}</td>
                <td>{{ p.exame_nome }}</td>
                <td>{{ p.prioridade }}</td>
                <td>{{ p.status }}</td>
            </tr>

            <tr class="detalhes-pedido" id="detalhe-{{ safe }}">
                <td colspan="4">
                    <div class="detalhe-box">
                        <p><strong>Protocolo:</strong> {{ p.protocolo }}</p>
                        <p><strong>Unidade:</strong> {{ p.unidade_nome }}</p>
                        <p><strong>Data do Pedido:</strong> {{ p.data_registro }}</p>

                        {% if p.altura or p.peso %}
                        <p><strong>Altura:</strong> {{ p.altura or "-" }} cm</p>
                        <p><strong>Peso:</strong> {{ p.peso or "-" }} kg</p>
                        {% endif %}

                        {% if p.observacoes %}
                        <p><strong>Observações:</strong> {{ p.observacoes }}</p>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/pesquisa_paciente.js') }}"></script>
<script src="{{ url_for('static', filename='js/regulacao.js') }}"></script>
{% endblock %}
